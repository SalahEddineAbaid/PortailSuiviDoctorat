<div class="autorisation-soutenance">
  <div class="generator-header">
    <h3>Autorisation de soutenance</h3>
    <p class="header-description">
      Générez votre autorisation officielle de soutenance de thèse
    </p>
  </div>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="loading$ | async">
    <mat-spinner diameter="40"></mat-spinner>
    <p>Chargement des informations...</p>
  </div>

  <form 
    [formGroup]="autorisationForm" 
    (ngSubmit)="onGenerate()" 
    class="autorisation-form"
    *ngIf="!(loading$ | async)">
    
    <!-- Soutenance Selection -->
    <div class="form-group" *ngIf="showSoutenanceSelector">
      <label for="soutenanceId" class="form-label">
        Soutenance <span class="required">*</span>
      </label>
      <select 
        id="soutenanceId"
        formControlName="soutenanceId"
        class="form-control"
        [class.invalid]="isFieldInvalid('soutenanceId')">
        <option value="">Sélectionnez une soutenance</option>
        <option *ngFor="let soutenance of soutenances" [value]="soutenance.id">
          {{ soutenance.titrethese }} ({{ soutenanceStatusLabel }})
        </option>
      </select>
      <div class="field-error" *ngIf="isFieldInvalid('soutenanceId')">
        {{ getFieldError('soutenanceId') }}
      </div>
    </div>

    <!-- Soutenance Information -->
    <div class="soutenance-info" *ngIf="selectedSoutenance">
      <h4>Informations de la soutenance</h4>
      <div class="info-grid">
        <div class="info-item">
          <span class="info-label">Titre:</span>
          <span class="info-value">{{ selectedSoutenance.titrethese }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Doctorant:</span>
          <span class="info-value">
            {{ selectedSoutenance.doctorant.FirstName }} {{ selectedSoutenance.doctorant.LastName }}
          </span>
        </div>
        <div class="info-item">
          <span class="info-label">Directeur:</span>
          <span class="info-value">
            {{ selectedSoutenance.directeur.FirstName }} {{ selectedSoutenance.directeur.LastName }}
          </span>
        </div>
        <div class="info-item">
          <span class="info-label">Statut:</span>
          <span class="info-value status" [class]="selectedSoutenance.statut.toLowerCase()">
            {{ soutenanceStatusLabel }}
          </span>
        </div>
      </div>
      
      <!-- Status Warning -->
      <div class="status-warning" *ngIf="!isValidForAutorisation">
        <mat-icon>warning</mat-icon>
        <span>Cette soutenance n'est pas dans un état valide pour générer une autorisation.</span>
      </div>
    </div>

    <!-- Planning Information -->
    <div class="planning-section" *ngIf="selectedSoutenance && isValidForAutorisation">
      <h4>Planification de la soutenance</h4>
      
      <!-- Date -->
      <div class="form-row">
        <div class="form-group">
          <label for="dateProposee" class="form-label">
            Date proposée <span class="required">*</span>
          </label>
          <input 
            type="date"
            id="dateProposee"
            formControlName="dateProposee"
            class="form-control"
            [class.invalid]="isFieldInvalid('dateProposee')"
            [min]="minDate">
          <div class="field-error" *ngIf="isFieldInvalid('dateProposee')">
            {{ getFieldError('dateProposee') }}
          </div>
        </div>

        <div class="form-group">
          <label for="heureProposee" class="form-label">
            Heure proposée <span class="required">*</span>
          </label>
          <input 
            type="time"
            id="heureProposee"
            formControlName="heureProposee"
            class="form-control"
            [class.invalid]="isFieldInvalid('heureProposee')">
          <div class="field-error" *ngIf="isFieldInvalid('heureProposee')">
            {{ getFieldError('heureProposee') }}
          </div>
        </div>
      </div>

      <!-- Lieu -->
      <div class="form-group">
        <label for="lieuPropose" class="form-label">
          Lieu proposé <span class="required">*</span>
        </label>
        <input 
          type="text"
          id="lieuPropose"
          formControlName="lieuPropose"
          class="form-control"
          [class.invalid]="isFieldInvalid('lieuPropose')"
          placeholder="Salle, bâtiment, adresse complète">
        <div class="field-error" *ngIf="isFieldInvalid('lieuPropose')">
          {{ getFieldError('lieuPropose') }}
        </div>
      </div>

      <!-- Commentaires -->
      <div class="form-group">
        <label for="commentaires" class="form-label">
          Commentaires additionnels
        </label>
        <textarea 
          id="commentaires"
          formControlName="commentaires"
          class="form-control textarea"
          placeholder="Informations complémentaires sur l'organisation de la soutenance"
          rows="3">
        </textarea>
      </div>
    </div>

    <!-- Messages -->
    <div class="message success" *ngIf="success$ | async as success">
      <mat-icon>check_circle</mat-icon>
      <span>{{ success }}</span>
    </div>

    <div class="message error" *ngIf="error$ | async as error">
      <mat-icon>error_outline</mat-icon>
      <span>{{ error }}</span>
    </div>

    <!-- Actions -->
    <div class="form-actions" *ngIf="selectedSoutenance">
      <button 
        type="button"
        mat-stroked-button
        (click)="onReset()"
        [disabled]="generating$ | async">
        Réinitialiser
      </button>
      
      <button 
        type="submit"
        mat-raised-button
        color="primary"
        [disabled]="!canGenerate">
        
        <mat-spinner *ngIf="generating$ | async" diameter="20" class="button-spinner"></mat-spinner>
        <mat-icon *ngIf="!(generating$ | async)">gavel</mat-icon>
        
        <span>
          {{ (generating$ | async) ? 'Génération...' : 'Générer l\'autorisation' }}
        </span>
      </button>
    </div>
  </form>
</div>