<div class="campagne-management">
  <!-- Header -->
  <div class="page-header">
    <h1>Gestion des Campagnes</h1>
    <button class="btn btn-primary" (click)="openCreateModal()">
      <i class="icon-plus"></i> Nouvelle Campagne
    </button>
  </div>

  <!-- Messages -->
  <div *ngIf="successMessage" class="alert alert-success">
    {{ successMessage }}
    <button class="close-btn" (click)="dismissSuccess()">&times;</button>
  </div>
  <div *ngIf="errorMessage" class="alert alert-error">
    {{ errorMessage }}
    <button class="close-btn" (click)="dismissError()">&times;</button>
  </div>

  <!-- Filters -->
  <div class="filters-section">
    <div class="filter-group">
      <input 
        type="text" 
        [(ngModel)]="searchTerm" 
        (ngModelChange)="applyFilters()"
        placeholder="Rechercher une campagne..."
        class="search-input"
      />
    </div>
    <div class="filter-group">
      <select [(ngModel)]="filterType" (ngModelChange)="applyFilters()">
        <option value="">Tous les types</option>
        <option [value]="TypeCampagne.INSCRIPTION">Inscription</option>
        <option [value]="TypeCampagne.REINSCRIPTION">R√©inscription</option>
        <option [value]="TypeCampagne.MIXTE">Mixte</option>
      </select>
    </div>
    <div class="filter-group">
      <select [(ngModel)]="filterStatus" (ngModelChange)="applyFilters()">
        <option value="">Tous les statuts</option>
        <option value="active">Active</option>
        <option value="future">√Ä venir</option>
        <option value="closed">Ferm√©e</option>
        <option value="inactive">Inactive</option>
      </select>
    </div>
    <div class="filter-group">
      <select [(ngModel)]="filterYear" (ngModelChange)="applyFilters()">
        <option value="">Toutes les ann√©es</option>
        <option *ngFor="let year of availableYears" [ngValue]="year">{{ year }}/{{ year + 1 }}</option>
      </select>
    </div>
    <button class="btn btn-secondary" (click)="resetFilters()">R√©initialiser</button>
  </div>

  <!-- Loading -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner"></div>
    <p>Chargement des campagnes...</p>
  </div>

  <!-- Campagnes List -->
  <div *ngIf="!isLoading" class="campagnes-grid">
    <div *ngIf="filteredCampagnes.length === 0" class="empty-state">
      <p>Aucune campagne trouv√©e</p>
    </div>

    <div *ngFor="let campagne of filteredCampagnes" class="campagne-card" [class]="'status-' + getStatus(campagne)">
      <div class="card-header">
        <h3>{{ campagne.libelle }}</h3>
        <span class="status-badge" [class]="'badge-' + getStatus(campagne)">
          {{ getStatusLabel(campagne) }}
        </span>
      </div>
      
      <div class="card-body">
        <div class="info-row">
          <span class="label">Type:</span>
          <span class="value type-badge" [class]="'type-' + campagne.type.toLowerCase()">
            {{ getTypeLabel(campagne.type) }}
          </span>
        </div>
        <div class="info-row">
          <span class="label">P√©riode:</span>
          <span class="value">{{ formatDate(campagne.dateDebut) }} - {{ formatDate(campagne.dateFin) }}</span>
        </div>
        <div class="info-row">
          <span class="label">Ann√©e:</span>
          <span class="value">{{ campagne.anneeUniversitaire }}/{{ campagne.anneeUniversitaire + 1 }}</span>
        </div>
        <div class="info-row" *ngIf="getStatus(campagne) === 'active'">
          <span class="label">Jours restants:</span>
          <span class="value days-remaining">{{ getDaysRemaining(campagne) }} jours</span>
        </div>
      </div>

      <div class="card-actions">
        <button class="btn btn-icon" title="Statistiques" (click)="openStatsModal(campagne)">
          üìä
        </button>
        <button class="btn btn-icon" title="Modifier" (click)="openEditModal(campagne)" *ngIf="canEdit(campagne)">
          ‚úèÔ∏è
        </button>
        <button class="btn btn-icon" title="Cloner" (click)="openCloneModal(campagne)">
          üìã
        </button>
        <button class="btn btn-icon btn-danger" title="Fermer" (click)="fermerCampagne(campagne)" *ngIf="canClose(campagne)">
          üîí
        </button>
      </div>
    </div>
  </div>
</div>


<!-- Create/Edit Modal -->
<div class="modal-overlay" *ngIf="showFormModal" (click)="closeFormModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ isEditMode ? 'Modifier la campagne' : 'Nouvelle campagne' }}</h2>
      <button class="close-btn" (click)="closeFormModal()">&times;</button>
    </div>
    
    <form [formGroup]="campagneForm" (ngSubmit)="saveCampagne()" class="modal-body">
      <div class="form-group">
        <label for="libelle">Libell√© *</label>
        <input 
          type="text" 
          id="libelle" 
          formControlName="libelle"
          placeholder="Ex: Campagne d'inscription 2024-2025"
        />
        <span class="error-text" *ngIf="campagneForm.get('libelle')?.touched && campagneForm.get('libelle')?.errors?.['required']">
          Le libell√© est requis
        </span>
        <span class="error-text" *ngIf="campagneForm.get('libelle')?.touched && campagneForm.get('libelle')?.errors?.['minlength']">
          Le libell√© doit contenir au moins 3 caract√®res
        </span>
      </div>

      <div class="form-group">
        <label for="type">Type *</label>
        <select id="type" formControlName="type">
          <option [value]="TypeCampagne.INSCRIPTION">Inscription</option>
          <option [value]="TypeCampagne.REINSCRIPTION">R√©inscription</option>
          <option [value]="TypeCampagne.MIXTE">Mixte</option>
        </select>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="dateDebut">Date de d√©but *</label>
          <input type="date" id="dateDebut" formControlName="dateDebut" />
          <span class="error-text" *ngIf="campagneForm.get('dateDebut')?.touched && campagneForm.get('dateDebut')?.errors?.['required']">
            La date de d√©but est requise
          </span>
        </div>

        <div class="form-group">
          <label for="dateFin">Date de fin *</label>
          <input type="date" id="dateFin" formControlName="dateFin" />
          <span class="error-text" *ngIf="campagneForm.get('dateFin')?.touched && campagneForm.get('dateFin')?.errors?.['required']">
            La date de fin est requise
          </span>
        </div>
      </div>

      <div class="form-group">
        <label for="anneeUniversitaire">Ann√©e universitaire *</label>
        <input type="number" id="anneeUniversitaire" formControlName="anneeUniversitaire" min="2020" />
        <span class="hint">Entrez l'ann√©e de d√©but (ex: 2024 pour 2024-2025)</span>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeFormModal()">Annuler</button>
        <button type="submit" class="btn btn-primary" [disabled]="isSaving || campagneForm.invalid">
          {{ isSaving ? 'Enregistrement...' : (isEditMode ? 'Modifier' : 'Cr√©er') }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Clone Modal -->
<div class="modal-overlay" *ngIf="showCloneModal" (click)="closeCloneModal()">
  <div class="modal modal-sm" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Cloner la campagne</h2>
      <button class="close-btn" (click)="closeCloneModal()">&times;</button>
    </div>
    
    <form [formGroup]="cloneForm" (ngSubmit)="cloneCampagne()" class="modal-body">
      <p class="clone-info">Cloner: <strong>{{ selectedCampagne?.libelle }}</strong></p>
      
      <div class="form-row">
        <div class="form-group">
          <label for="cloneDateDebut">Nouvelle date de d√©but *</label>
          <input type="date" id="cloneDateDebut" formControlName="dateDebut" />
        </div>

        <div class="form-group">
          <label for="cloneDateFin">Nouvelle date de fin *</label>
          <input type="date" id="cloneDateFin" formControlName="dateFin" />
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeCloneModal()">Annuler</button>
        <button type="submit" class="btn btn-primary" [disabled]="isSaving || cloneForm.invalid">
          {{ isSaving ? 'Clonage...' : 'Cloner' }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Statistics Modal -->
<div class="modal-overlay" *ngIf="showStatsModal" (click)="closeStatsModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Statistiques</h2>
      <button class="close-btn" (click)="closeStatsModal()">&times;</button>
    </div>
    
    <div class="modal-body">
      <h3>{{ selectedCampagne?.libelle }}</h3>
      
      <div *ngIf="!statistiques" class="loading-container">
        <div class="spinner"></div>
        <p>Chargement des statistiques...</p>
      </div>

      <div *ngIf="statistiques" class="stats-grid">
        <div class="stat-card">
          <span class="stat-value">{{ statistiques.totalInscriptions }}</span>
          <span class="stat-label">Total inscriptions</span>
        </div>
        <div class="stat-card stat-success">
          <span class="stat-value">{{ statistiques.inscriptionsValidees }}</span>
          <span class="stat-label">Valid√©es</span>
        </div>
        <div class="stat-card stat-warning">
          <span class="stat-value">{{ statistiques.inscriptionsEnAttente }}</span>
          <span class="stat-label">En attente</span>
        </div>
        <div class="stat-card stat-danger">
          <span class="stat-value">{{ statistiques.inscriptionsRejetees }}</span>
          <span class="stat-label">Rejet√©es</span>
        </div>
        <div class="stat-card stat-info full-width">
          <span class="stat-value">{{ statistiques.tauxValidation | number:'1.1-1' }}%</span>
          <span class="stat-label">Taux de validation</span>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeStatsModal()">Fermer</button>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" *ngIf="showDeleteConfirm" (click)="closeDeleteConfirm()">
  <div class="modal modal-sm" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Confirmer la fermeture</h2>
      <button class="close-btn" (click)="closeDeleteConfirm()">&times;</button>
    </div>
    
    <div class="modal-body">
      <p>√ätes-vous s√ªr de vouloir fermer la campagne <strong>{{ selectedCampagne?.libelle }}</strong> ?</p>
      <p class="warning-text">Cette action est irr√©versible.</p>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeDeleteConfirm()">Annuler</button>
      <button class="btn btn-danger" (click)="deleteCampagne()" [disabled]="isSaving">
        {{ isSaving ? 'Fermeture...' : 'Fermer la campagne' }}
      </button>
    </div>
  </div>
</div>
