<div class="user-list-container">
    <!-- Header -->
    <header class="list-header">
        <div class="header-content">
            <h1>Gestion des Utilisateurs</h1>
            <p class="subtitle">{{ totalElements }} utilisateur(s)</p>
        </div>
        <button class="btn btn-primary" (click)="openCreateModal()">
            <i class="icon-user-plus"></i>
            Nouvel utilisateur
        </button>
    </header>

    <!-- Success/Error Messages -->
    <div class="alert alert-success" *ngIf="successMessage">
        <i class="icon-check-circle"></i>
        {{ successMessage }}
    </div>
    <div class="alert alert-error" *ngIf="errorMessage">
        <i class="icon-alert-circle"></i>
        {{ errorMessage }}
    </div>

    <!-- Filters -->
    <div class="filters-section">
        <div class="filters-container">
            <!-- Search -->
            <div class="filter-group search-group">
                <label for="search">
                    <i class="icon-search"></i>
                    Rechercher
                </label>
                <input type="text" id="search" placeholder="Email, nom, prénom, téléphone..."
                    [ngModel]="filters.searchTerm" (ngModelChange)="onSearchChange($event)" class="search-input">
            </div>

            <!-- Role Filter -->
            <div class="filter-group">
                <label for="role">Rôle</label>
                <select id="role" [(ngModel)]="filters.role" (ngModelChange)="onFilterChange()" class="filter-select">
                    <option *ngFor="let role of availableRoles" [value]="role">
                        {{ role === 'ALL' ? 'Tous les rôles' : role }}
                    </option>
                </select>
            </div>

            <!-- Status Filter -->
            <div class="filter-group">
                <label for="status">Statut</label>
                <select id="status" [(ngModel)]="filters.status" (ngModelChange)="onFilterChange()"
                    class="filter-select">
                    <option value="ALL">Tous</option>
                    <option value="ACTIVE">Actifs</option>
                    <option value="DISABLED">Désactivés</option>
                </select>
            </div>

            <!-- Clear Filters -->
            <button class="btn btn-secondary" (click)="clearFilters()">
                <i class="icon-x"></i>
                Réinitialiser
            </button>
        </div>
    </div>

    <!-- Loading State -->
    <div class="loading-container" *ngIf="isLoading">
        <div class="spinner"></div>
        <p>Chargement des utilisateurs...</p>
    </div>

    <!-- Error State -->
    <div class="error-container" *ngIf="errorMessage && !isLoading">
        <i class="icon-alert-circle"></i>
        <p>{{ errorMessage }}</p>
        <button class="btn btn-primary" (click)="loadUsers()">Réessayer</button>
    </div>

    <!-- Users Table -->
    <div class="table-container" *ngIf="!isLoading && filteredUsers.length > 0">
        <table class="users-table">
            <thead>
                <tr>
                    <th>Nom</th>
                    <th>Email</th>
                    <th>Rôles</th>
                    <th>Téléphone</th>
                    <th>Statut</th>
                    <th>Créé le</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let user of getPaginatedUsers()" class="user-row">
                    <td class="user-name">{{ getFullName(user) }}</td>
                    <td>{{ user.email }}</td>
                    <td>
                        <div class="roles-badges">
                            <span class="role-badge" *ngFor="let role of user.roles">
                                {{ role }}
                            </span>
                        </div>
                    </td>
                    <td>{{ user.tel || '-' }}</td>
                    <td>
                        <span class="status-badge" [class]="'status-' + getStatusColor(user)">
                            {{ getUserStatus(user) }}
                        </span>
                    </td>
                    <td>-</td>
                    <td class="actions-cell">
                        <div class="action-buttons">
                            <!-- View -->
                            <button class="btn-icon" (click)="viewUser(user.id)" title="Voir les détails">
                                <i class="icon-eye"></i>
                            </button>

                            <!-- Edit -->
                            <button class="btn-icon" (click)="editUser(user.id)" title="Modifier">
                                <i class="icon-edit"></i>
                            </button>

                            <!-- Enable/Disable -->
                            <button class="btn-icon" [class.btn-success]="!isUserEnabled(user)"
                                [class.btn-warning]="isUserEnabled(user)"
                                (click)="isUserEnabled(user) ? disableUser(user) : enableUser(user)"
                                [title]="isUserEnabled(user) ? 'Désactiver' : 'Activer'">
                                <i
                                    [class]="isUserEnabled(user) ? 'icon-x-circle' : 'icon-check-circle'"></i>
                            </button>

                            <!-- Delete -->
                            <button class="btn-icon btn-danger" (click)="deleteUser(user)" title="Supprimer">
                                <i class="icon-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="!isLoading && filteredUsers.length === 0">
        <i class="icon-users"></i>
        <h3>Aucun utilisateur trouvé</h3>
        <p *ngIf="filters.searchTerm || filters.role !== 'ALL' || filters.status !== 'ALL'">
            Essayez de modifier vos critères de recherche
        </p>
        <button class="btn btn-primary" (click)="clearFilters()">
            Réinitialiser les filtres
        </button>
    </div>

    <!-- Pagination -->
    <div class="pagination-container" *ngIf="totalPages > 1">
        <button class="btn btn-secondary" (click)="onPageChange(currentPage - 1)" [disabled]="currentPage === 0">
            Précédent
        </button>

        <div class="page-numbers">
            <button *ngFor="let page of [].constructor(totalPages); let i = index" class="page-number"
                [class.active]="currentPage === i" (click)="onPageChange(i)">
                {{ i + 1 }}
            </button>
        </div>

        <button class="btn btn-secondary" (click)="onPageChange(currentPage + 1)"
            [disabled]="currentPage === totalPages - 1">
            Suivant
        </button>

        <span class="pagination-info">
            Page {{ currentPage + 1 }} sur {{ totalPages }} ({{ totalElements }} utilisateur(s))
        </span>
    </div>
</div>

<!-- Create User Modal -->
<div class="modal-overlay" *ngIf="showCreateModal" (click)="closeCreateModal()">
    <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h2>Nouvel utilisateur</h2>
            <button class="close-btn" (click)="closeCreateModal()">&times;</button>
        </div>
        
        <form [formGroup]="userForm" (ngSubmit)="createUser()" class="modal-body">
            <div class="form-row">
                <div class="form-group">
                    <label for="firstName">Prénom *</label>
                    <input type="text" id="firstName" formControlName="firstName" placeholder="Prénom" />
                    <span class="error-text" *ngIf="userForm.get('firstName')?.touched && userForm.get('firstName')?.errors?.['required']">
                        Le prénom est requis
                    </span>
                </div>

                <div class="form-group">
                    <label for="lastName">Nom *</label>
                    <input type="text" id="lastName" formControlName="lastName" placeholder="Nom" />
                    <span class="error-text" *ngIf="userForm.get('lastName')?.touched && userForm.get('lastName')?.errors?.['required']">
                        Le nom est requis
                    </span>
                </div>
            </div>

            <div class="form-group">
                <label for="email">Email *</label>
                <input type="email" id="email" formControlName="email" placeholder="email@exemple.com" />
                <span class="error-text" *ngIf="userForm.get('email')?.touched && userForm.get('email')?.errors?.['required']">
                    L'email est requis
                </span>
                <span class="error-text" *ngIf="userForm.get('email')?.touched && userForm.get('email')?.errors?.['email']">
                    Format d'email invalide
                </span>
            </div>

            <div class="form-group">
                <label for="tel">Téléphone</label>
                <input type="tel" id="tel" formControlName="tel" placeholder="0600000000" />
            </div>

            <div class="form-group">
                <label for="password">Mot de passe *</label>
                <input type="password" id="password" formControlName="password" placeholder="Minimum 6 caractères" />
                <span class="error-text" *ngIf="userForm.get('password')?.touched && userForm.get('password')?.errors?.['required']">
                    Le mot de passe est requis
                </span>
                <span class="error-text" *ngIf="userForm.get('password')?.touched && userForm.get('password')?.errors?.['minlength']">
                    Le mot de passe doit contenir au moins 6 caractères
                </span>
            </div>

            <div class="form-group">
                <label for="role">Rôle *</label>
                <select id="role" formControlName="role">
                    <option value="DOCTORANT">Doctorant</option>
                    <option value="DIRECTEUR">Directeur</option>
                    <option value="PED">PED</option>
                    <option value="ADMIN">Administrateur</option>
                </select>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="closeCreateModal()">Annuler</button>
                <button type="submit" class="btn btn-primary" [disabled]="isSaving || userForm.invalid">
                    {{ isSaving ? 'Création...' : 'Créer l\'utilisateur' }}
                </button>
            </div>
        </form>
    </div>
</div>