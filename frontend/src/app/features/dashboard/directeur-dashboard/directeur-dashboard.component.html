<div class="dashboard-layout">
  <!-- Sidebar -->
  <app-sidebar [menuItems]="menuItems"></app-sidebar>

  <!-- Main Content -->
  <div class="dashboard-main">
    <!-- Navbar -->
    <app-navbar [user]="dashboard?.user || null"></app-navbar>

    <!-- Dashboard Content -->
    <div class="dashboard-content">
      <!-- Header -->
      <div class="dashboard-header">
        <div class="welcome-section">
          <h1>{{ getWelcomeMessage() }}, {{ getUserName() }} üë®‚Äçüè´</h1>
          <p class="subtitle">Tableau de bord de supervision</p>
        </div>
        <button class="btn-refresh" (click)="refreshDashboard()" [disabled]="isLoading">
          <i class="fas fa-sync-alt" [class.spinning]="isLoading"></i>
          Actualiser
        </button>
      </div>

      <!-- Error Message -->
      <div *ngIf="error" class="error-message">
        <i class="fas fa-exclamation-triangle"></i>
        {{ error }}
      </div>

      <!-- Loading State -->
      <div *ngIf="isLoading" class="loading-state">
        <div class="spinner"></div>
        <p>Chargement de votre dashboard...</p>
      </div>

      <!-- Dashboard Content -->
      <div *ngIf="!isLoading && dashboard" class="dashboard-grid">
        
        <!-- Row 1: Statistics Cards -->
        <div class="stats-row">
          <div class="stat-card">
            <div class="stat-icon primary">
              <i class="fas fa-users"></i>
            </div>
            <div class="stat-content">
              <h3>{{ dashboard.statistics.totalDoctorants }}</h3>
              <p>Doctorants supervis√©s</p>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon warning">
              <i class="fas fa-clock"></i>
            </div>
            <div class="stat-content">
              <h3>{{ dashboard.statistics.demandesEnAttente }}</h3>
              <p>Demandes en attente</p>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon success">
              <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-content">
              <h3>{{ dashboard.statistics.tauxValidation }}%</h3>
              <p>Taux de validation</p>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon info">
              <i class="fas fa-user-check"></i>
            </div>
            <div class="stat-content">
              <h3>{{ dashboard.statistics.doctorantsActifs }}</h3>
              <p>Doctorants actifs</p>
            </div>
          </div>
        </div>

        <!-- Row 2: Demandes en attente & Doctorants -->
        <div class="content-row">
          <!-- Demandes en attente Widget -->
          <div class="widget demandes-widget">
            <div class="widget-header">
              <h2>
                <i class="fas fa-tasks"></i> 
                Demandes en attente
                <span *ngIf="dashboard.statistics.demandesEnAttente > 0" class="badge-count">
                  {{ dashboard.statistics.demandesEnAttente }}
                </span>
              </h2>
              <a routerLink="/directeur/validations" class="view-all">Voir tout</a>
            </div>
            <div class="widget-body">
              <div *ngIf="!hasDemandesEnAttente()" class="empty-state">
                <i class="fas fa-check-double"></i>
                <p>Aucune demande en attente</p>
              </div>

              <div *ngIf="hasDemandesEnAttente()" class="demandes-list">
                <div 
                  *ngFor="let demande of dashboard.demandesEnAttente" 
                  class="demande-item"
                  [class.priority-haute]="demande.priorite === 'haute'"
                >
                  <div class="demande-header">
                    <div class="demande-info">
                      <h4>{{ demande.doctorantPrenom }} {{ demande.doctorantNom }}</h4>
                      <p class="demande-type">
                        <i [class]="'fas fa-' + (demande.type === 'inscription' ? 'file-alt' : 'exclamation-circle')"></i>
                        {{ demande.description }}
                      </p>
                      <span class="demande-date">
                        <i class="fas fa-calendar"></i>
                        {{ demande.dateCreation | date:'dd/MM/yyyy' }}
                      </span>
                    </div>
                    <div class="demande-priority">
                      <span class="badge" [class]="'badge-' + demande.priorite">
                        {{ demande.priorite }}
                      </span>
                    </div>
                  </div>
                  
                  <div class="demande-actions">
                    <button 
                      class="btn-action btn-view"
                      (click)="onViewRequest(demande.id)"
                      title="Voir les d√©tails"
                    >
                      <i class="fas fa-eye"></i>
                      Voir
                    </button>
                    <button 
                      class="btn-action btn-approve"
                      (click)="onApproveRequest(demande.id)"
                      title="Valider"
                    >
                      <i class="fas fa-check"></i>
                      Valider
                    </button>
                    <button 
                      class="btn-action btn-reject"
                      (click)="onRejectRequest(demande.id)"
                      title="Rejeter"
                    >
                      <i class="fas fa-times"></i>
                      Rejeter
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Doctorants Widget -->
          <div class="widget doctorants-widget">
            <div class="widget-header">
              <h2><i class="fas fa-graduation-cap"></i> Mes doctorants</h2>
              <a routerLink="/directeur/doctorants" class="view-all">Voir tout</a>
            </div>
            <div class="widget-body">
              <div *ngIf="!hasDoctorants()" class="empty-state">
                <i class="fas fa-user-graduate"></i>
                <p>Aucun doctorant supervis√©</p>
              </div>

              <div *ngIf="hasDoctorants()" class="doctorants-list">
                <div 
                  *ngFor="let doctorant of dashboard.doctorants" 
                  class="doctorant-item"
                  [routerLink]="['/directeur/doctorants', doctorant.id]"
                >
                  <div class="doctorant-avatar">
                    <i class="fas fa-user-circle"></i>
                  </div>
                  <div class="doctorant-info">
                    <h4>{{ doctorant.prenom }} {{ doctorant.nom }}</h4>
                    <p class="doctorant-email">{{ doctorant.email }}</p>
                    <p class="doctorant-sujet">{{ doctorant.sujetThese || 'Sujet non d√©fini' }}</p>
                    <div class="doctorant-meta">
                      <span class="meta-item">
                        <i class="fas fa-calendar"></i>
                        {{ doctorant.anneesEcoulees }} ann√©e(s)
                      </span>
                      <span class="badge" [class]="'badge-' + doctorant.statut">
                        {{ doctorant.statut }}
                      </span>
                    </div>
                    <div *ngIf="doctorant.alertes && doctorant.alertes.length > 0" class="doctorant-alerts">
                      <span *ngFor="let alerte of doctorant.alertes" class="alert-badge">
                        <i class="fas fa-exclamation-triangle"></i>
                        {{ alerte }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Row 3: Statistiques & Notifications -->
        <div class="content-row">
          <!-- Statistiques Widget -->
          <div class="widget statistics-widget">
            <div class="widget-header">
              <h2><i class="fas fa-chart-bar"></i> Statistiques de supervision</h2>
            </div>
            <div class="widget-body">
              <div class="stats-grid">
                <div class="stat-item">
                  <div class="stat-label">Total doctorants</div>
                  <div class="stat-value primary">{{ dashboard.statistics.totalDoctorants }}</div>
                  <div class="stat-bar">
                    <div class="stat-bar-fill primary" [style.width.%]="100"></div>
                  </div>
                </div>

                <div class="stat-item">
                  <div class="stat-label">Doctorants actifs</div>
                  <div class="stat-value success">{{ dashboard.statistics.doctorantsActifs }}</div>
                  <div class="stat-bar">
                    <div 
                      class="stat-bar-fill success" 
                      [style.width.%]="(dashboard.statistics.doctorantsActifs / dashboard.statistics.totalDoctorants) * 100"
                    ></div>
                  </div>
                </div>

                <div class="stat-item">
                  <div class="stat-label">Demandes valid√©es</div>
                  <div class="stat-value info">{{ dashboard.statistics.demandesValidees }}</div>
                  <div class="stat-bar">
                    <div 
                      class="stat-bar-fill info" 
                      [style.width.%]="dashboard.statistics.tauxValidation"
                    ></div>
                  </div>
                </div>

                <div class="stat-item">
                  <div class="stat-label">Demandes rejet√©es</div>
                  <div class="stat-value danger">{{ dashboard.statistics.demandesRejetees }}</div>
                  <div class="stat-bar">
                    <div 
                      class="stat-bar-fill danger" 
                      [style.width.%]="(dashboard.statistics.demandesRejetees / (dashboard.statistics.demandesValidees + dashboard.statistics.demandesRejetees || 1)) * 100"
                    ></div>
                  </div>
                </div>

                <div class="stat-item">
                  <div class="stat-label">Taux de validation</div>
                  <div class="stat-value warning">{{ dashboard.statistics.tauxValidation }}%</div>
                  <div class="stat-bar">
                    <div class="stat-bar-fill warning" [style.width.%]="dashboard.statistics.tauxValidation"></div>
                  </div>
                </div>

                <div class="stat-item">
                  <div class="stat-label">D√©lai moyen de validation</div>
                  <div class="stat-value primary">{{ dashboard.statistics.moyenneDelaiValidation }} jours</div>
                  <div class="stat-bar">
                    <div class="stat-bar-fill primary" [style.width.%]="50"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Notifications Widget -->
          <div class="widget notifications-widget">
            <div class="widget-header">
              <h2>
                <i class="fas fa-bell"></i> 
                Notifications
                <span *ngIf="getNotificationCount() > 0" class="badge-count">{{ getNotificationCount() }}</span>
              </h2>
              <a routerLink="/notifications" class="view-all">Voir tout</a>
            </div>
            <div class="widget-body">
              <div *ngIf="!hasNotifications()" class="empty-state">
                <i class="fas fa-bell-slash"></i>
                <p>Aucune notification</p>
              </div>

              <div *ngIf="hasNotifications()" class="notifications-list">
                <div 
                  *ngFor="let notification of dashboard.notifications" 
                  class="notification-item"
                  [class.unread]="!notification.lu"
                >
                  <div class="notification-icon" [class]="'priority-' + notification.priorite">
                    <i class="fas fa-info-circle"></i>
                  </div>
                  <div class="notification-content">
                    <h4>{{ notification.titre }}</h4>
                    <p>{{ notification.message }}</p>
                    <span class="notification-date">{{ notification.dateCreation | date:'dd/MM/yyyy HH:mm' }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>
