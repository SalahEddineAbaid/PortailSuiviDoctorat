<div class="reinscription-container">
  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Chargement des données...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-container">
    <mat-icon color="warn">error</mat-icon>
    <p>{{ error }}</p>
    <button mat-raised-button color="primary" routerLink="/inscription/dashboard">
      Retour au dashboard
    </button>
  </div>

  <!-- Form Content -->
  <div *ngIf="!loading && !error && previousInscription" class="form-content">
    <!-- Header -->
    <div class="form-header">
      <h1>Formulaire de Réinscription</h1>
      <p class="subtitle">Année universitaire {{ campagneActive?.anneeUniversitaire }}</p>
      
      <!-- Derogation Warning -->
      <mat-card *ngIf="requiresDerogation" class="warning-card">
        <mat-card-content>
          <div class="warning-content">
            <mat-icon color="warn">warning</mat-icon>
            <div>
              <h3>Dérogation requise</h3>
              <p>Votre doctorat dure depuis {{ dureeDoctoratAnnees }} ans. Une demande de dérogation est nécessaire pour continuer.</p>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Stepper -->
    <mat-stepper #stepper linear>
      <!-- Step 1: Vérification -->
      <mat-step [stepControl]="verificationForm">
        <ng-template matStepLabel>Vérification des données</ng-template>
        
        <div class="step-content">
          <h2>Vérifiez vos informations</h2>
          <p class="step-description">
            Voici les informations de votre dernière inscription. Vous pourrez les modifier à l'étape suivante.
          </p>

          <mat-card class="info-card">
            <mat-card-header>
              <mat-card-title>Informations personnelles</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="info-grid">
                <div class="info-item">
                  <span class="label">CIN:</span>
                  <span class="value">{{ previousInscription.infosDoctorant.cin }}</span>
                </div>
                <div class="info-item">
                  <span class="label">CNE:</span>
                  <span class="value">{{ previousInscription.infosDoctorant.cne || 'N/A' }}</span>
                </div>
                <div class="info-item">
                  <span class="label">Téléphone:</span>
                  <span class="value">{{ previousInscription.infosDoctorant.telephone }}</span>
                </div>
                <div class="info-item">
                  <span class="label">Adresse:</span>
                  <span class="value">{{ previousInscription.infosDoctorant.adresse }}</span>
                </div>
                <div class="info-item">
                  <span class="label">Ville:</span>
                  <span class="value">{{ previousInscription.infosDoctorant.ville }}</span>
                </div>
                <div class="info-item">
                  <span class="label">Nationalité:</span>
                  <span class="value">{{ previousInscription.infosDoctorant.nationalite }}</span>
                </div>
              </div>
            </mat-card-content>
          </mat-card>

          <mat-card class="info-card">
            <mat-card-header>
              <mat-card-title>Informations de thèse</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="info-grid">
                <div class="info-item full-width">
                  <span class="label">Titre:</span>
                  <span class="value">{{ previousInscription.infosThese.titreThese }}</span>
                </div>
                <div class="info-item">
                  <span class="label">Discipline:</span>
                  <span class="value">{{ previousInscription.infosThese.discipline }}</span>
                </div>
                <div class="info-item">
                  <span class="label">Laboratoire:</span>
                  <span class="value">{{ previousInscription.infosThese.laboratoire }}</span>
                </div>
                <div class="info-item">
                  <span class="label">Établissement:</span>
                  <span class="value">{{ previousInscription.infosThese.etablissementAccueil }}</span>
                </div>
                <div class="info-item">
                  <span class="label">Date début:</span>
                  <span class="value">{{ (previousInscription.infosThese.dateDebutEffective || previousInscription.infosThese.dateDebutPrevue) | date:'dd/MM/yyyy' }}</span>
                </div>
              </div>
            </mat-card-content>
          </mat-card>

          <form [formGroup]="verificationForm">
            <mat-checkbox formControlName="confirmed">
              Je confirme avoir vérifié mes informations
            </mat-checkbox>
          </form>

          <div class="step-actions">
            <button mat-button (click)="onCancel()">Annuler</button>
            <button mat-raised-button color="primary" matStepperNext [disabled]="!verificationForm.valid">
              Suivant
            </button>
          </div>
        </div>
      </mat-step>

      <!-- Step 2: Modifications -->
      <mat-step [stepControl]="modificationsForm">
        <ng-template matStepLabel>Modifications</ng-template>
        
        <div class="step-content">
          <h2>Mettez à jour vos informations</h2>
          <p class="step-description">
            Modifiez les informations qui ont changé depuis votre dernière inscription.
          </p>

          <form [formGroup]="modificationsForm">
            <mat-card class="form-section">
              <mat-card-header>
                <mat-card-title>Coordonnées</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="form-row">
                  <mat-form-field appearance="outline">
                    <mat-label>Téléphone</mat-label>
                    <input matInput formControlName="telephone" placeholder="0612345678">
                    <mat-icon matPrefix>phone</mat-icon>
                    <mat-error>Format invalide (10 chiffres)</mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Ville</mat-label>
                    <input matInput formControlName="ville">
                    <mat-icon matPrefix>location_city</mat-icon>
                    <mat-error>Ce champ est obligatoire</mat-error>
                  </mat-form-field>
                </div>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Adresse</mat-label>
                  <textarea matInput formControlName="adresse" rows="2"></textarea>
                  <mat-icon matPrefix>home</mat-icon>
                  <mat-error>Ce champ est obligatoire</mat-error>
                </mat-form-field>
              </mat-card-content>
            </mat-card>

            <mat-card class="form-section">
              <mat-card-header>
                <mat-card-title>Informations de thèse</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Titre de la thèse</mat-label>
                  <textarea matInput formControlName="titreThese" rows="3"></textarea>
                  <mat-error>Minimum 10 caractères</mat-error>
                </mat-form-field>

                <div class="form-row">
                  <mat-form-field appearance="outline">
                    <mat-label>Laboratoire</mat-label>
                    <input matInput formControlName="laboratoire">
                    <mat-error>Ce champ est obligatoire</mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Établissement d'accueil</mat-label>
                    <input matInput formControlName="etablissementAccueil">
                    <mat-error>Ce champ est obligatoire</mat-error>
                  </mat-form-field>
                </div>
              </mat-card-content>
            </mat-card>
          </form>

          <div class="step-actions">
            <button mat-button matStepperPrevious>Précédent</button>
            <button mat-raised-button color="primary" matStepperNext [disabled]="!modificationsForm.valid">
              Suivant
            </button>
          </div>
        </div>
      </mat-step>

      <!-- Step 3: Documents -->
      <mat-step [stepControl]="documentsForm">
        <ng-template matStepLabel>Documents</ng-template>
        
        <div class="step-content">
          <h2>Téléchargez vos documents</h2>
          <p class="step-description">
            Veuillez fournir les documents requis pour votre réinscription.
          </p>

          <!-- Progress -->
          <mat-card class="progress-card">
            <mat-card-content>
              <div class="progress-info">
                <span>Progression: {{ uploadProgressPercentage }}%</span>
                <span>{{ uploadedDocuments.size }} / {{ requiredDocuments.length }} documents</span>
              </div>
              <mat-progress-bar mode="determinate" [value]="uploadProgressPercentage"></mat-progress-bar>
            </mat-card-content>
          </mat-card>

          <!-- Document Upload -->
          <div class="documents-list">
            <mat-card *ngFor="let docConfig of requiredDocuments" class="document-card">
              <mat-card-content>
                <div class="document-header">
                  <div class="document-info">
                    <h3>{{ docConfig.label }}</h3>
                    <p class="document-description">{{ docConfig.description }}</p>
                    <mat-chip-set>
                      <mat-chip *ngIf="docConfig.obligatoire" class="required-chip">Obligatoire</mat-chip>
                      <mat-chip class="format-chip">{{ docConfig.allowedTypes.join(', ') }}</mat-chip>
                      <mat-chip class="size-chip">Max {{ docConfig.maxSizeMB }}MB</mat-chip>
                    </mat-chip-set>
                  </div>
                  
                  <div class="document-actions">
                    <input type="file" 
                           #fileInput
                           [accept]="docConfig.allowedTypes.join(',')"
                           (change)="onFileSelected($event, docConfig.type)"
                           style="display: none">
                    
                    <button *ngIf="!uploadedDocuments.has(docConfig.type)" 
                            mat-raised-button 
                            color="primary"
                            (click)="fileInput.click()">
                      <mat-icon>upload</mat-icon>
                      Télécharger
                    </button>

                    <div *ngIf="uploadedDocuments.has(docConfig.type)" class="uploaded-info">
                      <mat-icon color="primary">check_circle</mat-icon>
                      <span>{{ uploadedDocuments.get(docConfig.type)?.nomFichier }}</span>
                      <button mat-icon-button color="warn" (click)="removeDocument(docConfig.type)">
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Upload Progress -->
                <mat-progress-bar *ngIf="uploadProgress.has(docConfig.type)" 
                                  mode="determinate" 
                                  [value]="uploadProgress.get(docConfig.type)">
                </mat-progress-bar>
              </mat-card-content>
            </mat-card>
          </div>

          <div class="step-actions">
            <button mat-button matStepperPrevious>Précédent</button>
            <button mat-raised-button color="primary" matStepperNext [disabled]="!allRequiredDocumentsUploaded">
              Suivant
            </button>
          </div>
        </div>
      </mat-step>

      <!-- Step 4: Dérogation (if required) -->
      <mat-step [stepControl]="derogationForm" *ngIf="requiresDerogation">
        <ng-template matStepLabel>Dérogation</ng-template>
        
        <div class="step-content">
          <h2>Demande de dérogation</h2>
          <p class="step-description">
            Votre doctorat dure depuis plus de 3 ans. Veuillez justifier votre demande de dérogation.
          </p>

          <form [formGroup]="derogationForm">
            <mat-card class="form-section">
              <mat-card-content>
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Motif de la dérogation</mat-label>
                  <mat-select formControlName="motif">
                    <mat-option value="RECHERCHE_COMPLEXE">Complexité de la recherche</mat-option>
                    <mat-option value="PROBLEMES_SANTE">Problèmes de santé</mat-option>
                    <mat-option value="RAISONS_FAMILIALES">Raisons familiales</mat-option>
                    <mat-option value="FINANCEMENT">Problèmes de financement</mat-option>
                    <mat-option value="AUTRE">Autre</mat-option>
                  </mat-select>
                  <mat-error>Veuillez sélectionner un motif</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Justification détaillée</mat-label>
                  <textarea matInput 
                            formControlName="justification" 
                            rows="6"
                            placeholder="Expliquez en détail les raisons de votre demande de dérogation..."></textarea>
                  <mat-hint>Minimum 50 caractères</mat-hint>
                  <mat-error>Justification trop courte (minimum 50 caractères)</mat-error>
                </mat-form-field>
              </mat-card-content>
            </mat-card>
          </form>

          <div class="step-actions">
            <button mat-button matStepperPrevious>Précédent</button>
            <button mat-raised-button color="primary" matStepperNext [disabled]="!derogationForm.valid">
              Suivant
            </button>
          </div>
        </div>
      </mat-step>

      <!-- Step 5: Récapitulatif -->
      <mat-step>
        <ng-template matStepLabel>Récapitulatif</ng-template>
        
        <div class="step-content">
          <h2>Récapitulatif de votre réinscription</h2>
          <p class="step-description">
            Vérifiez toutes les informations avant de soumettre votre réinscription.
          </p>

          <mat-card class="summary-card">
            <mat-card-header>
              <mat-card-title>Informations modifiées</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="summary-grid">
                <div class="summary-item">
                  <span class="label">Téléphone:</span>
                  <span class="value">{{ modificationsForm.value.telephone }}</span>
                </div>
                <div class="summary-item">
                  <span class="label">Ville:</span>
                  <span class="value">{{ modificationsForm.value.ville }}</span>
                </div>
                <div class="summary-item full-width">
                  <span class="label">Adresse:</span>
                  <span class="value">{{ modificationsForm.value.adresse }}</span>
                </div>
              </div>
            </mat-card-content>
          </mat-card>

          <mat-card class="summary-card">
            <mat-card-header>
              <mat-card-title>Documents téléchargés</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="documents-summary">
                <div *ngFor="let doc of uploadedDocuments | keyvalue" class="document-item">
                  <mat-icon color="primary">check_circle</mat-icon>
                  <span>{{ doc.value.nomFichier }}</span>
                </div>
              </div>
            </mat-card-content>
          </mat-card>

          <mat-card *ngIf="requiresDerogation" class="summary-card warning">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>warning</mat-icon>
                Dérogation demandée
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <p><strong>Motif:</strong> {{ derogationForm.value.motif }}</p>
              <p><strong>Justification:</strong> {{ derogationForm.value.justification }}</p>
            </mat-card-content>
          </mat-card>

          <div class="step-actions">
            <button mat-button matStepperPrevious>Précédent</button>
            <button mat-raised-button 
                    color="primary" 
                    (click)="onSubmit()"
                    [disabled]="submitting">
              <mat-spinner *ngIf="submitting" diameter="20"></mat-spinner>
              <span *ngIf="!submitting">Soumettre la réinscription</span>
            </button>
          </div>
        </div>
      </mat-step>
    </mat-stepper>
  </div>
</div>
